<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        Lab 4 - Mongodb - CodiMD
    </title>
    <link rel="icon" type="image/png" href="http://localhost:3000/favicon.png">
    <link rel="apple-touch-icon" href="http://localhost:3000/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.0/css/bootstrap.min.css" integrity="sha256-H0KfTigpUV+0/5tn2HXC0CPwhhDhWgSawJdnFd0CGCo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.3/css/fork-awesome.min.css" integrity="sha256-ZhApazu+kejqTYhMF+1DzNKjIzP7KXu6AzyXcC1gMus=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@hackmd/emojify.js@2.1.0/dist/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,300italic,300|Source+Serif+Pro|Source+Code+Pro:400,300,500&subset=latin,latin-ext);.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{padding:0 1em;color:#777;border-left:.25em solid #ddd}.night .markdown-body blockquote{color:#bcbcbc}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.night .markdown-body h1,.night .markdown-body h2,.night .markdown-body h3,.night .markdown-body h4,.night .markdown-body h5,.night .markdown-body h6{color:#ddd}.markdown-body h1 .fa-link,.markdown-body h2 .fa-link,.markdown-body h3 .fa-link,.markdown-body h4 .fa-link,.markdown-body h5 .fa-link,.markdown-body h6 .fa-link{color:#000;vertical-align:middle;visibility:hidden;font-size:16px}.night .markdown-body h1 .fa-link,.night .markdown-body h2 .fa-link,.night .markdown-body h3 .fa-link,.night .markdown-body h4 .fa-link,.night .markdown-body h5 .fa-link,.night .markdown-body h6 .fa-link{color:#fff}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .fa-link,.markdown-body h2:hover .anchor .fa-link,.markdown-body h3:hover .anchor .fa-link,.markdown-body h4:hover .anchor .fa-link,.markdown-body h5:hover .anchor .fa-link,.markdown-body h6:hover .anchor .fa-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.night .markdown-body table tr{background-color:#5f5f5f}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.night .markdown-body table tr:nth-child(2n){background-color:#4f4f4f}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.night .markdown-body code,.night .markdown-body tt{color:#eee;background-color:hsla(0,0%,90.2%,.36)}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\A0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid;border-color:#ccc #ccc #bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body pre{border:inherit!important}.night .markdown-body pre{filter:invert(100%)}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-webkit-inline-flex;display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.night .markdown-body .gist table tr:nth-child(2n){background-color:#ddd}.markdown-body code[data-gist-id]{background:none;padding:0;filter:invert(100%)}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.geo,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram,.markdown-body pre.vega{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.night .markdown-body pre.graphviz .graph>polygon{fill:#333}.night .markdown-body pre.mermaid .sectionTitle,.night .markdown-body pre.mermaid .titleText,.night .markdown-body pre.mermaid text{fill:#fff}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code,.markdown-body pre.vega>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg,.markdown-body pre.vega>svg{max-width:100%;height:100%}.night .markdown-body .abc path{fill:#eee}.night .markdown-body .abc path.note_selected{fill:##4DD0E1}.night tspan{fill:#fefefe}.night pre rect{fill:transparent}.night pre.flow-chart path,.night pre.flow-chart rect{stroke:#fff}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.markdown-body summary{display:list-item}.markdown-body summary:focus{outline:none}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none}.markdown-body figure{margin:1em 40px}.markdown-body img{background-color:transparent}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;-webkit-transition:opacity .2s;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;-webkit-transition:opacity .2s;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.geo-map{width:100%;height:250px}.markmap-container{height:300px}.markmap-container>svg{width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.toc .invisable-node{list-style-type:none}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.9;background-color:#ccc;border:none}.ui-toc-label,.ui-toc .open .ui-toc-label{-webkit-transition:opacity .2s;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#5f5f5f}.ui-toc-label:focus{opacity:1;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;-webkit-transition:opacity .2s;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child>ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.night .ui-toc-dropdown .nav>li>a:focus,.night .ui-toc-dropdown .nav>li>a:hover{color:#fff;border-left-color:#fff}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.night .ui-toc-dropdown .nav>.active:focus>a,.night .ui-toc-dropdown .nav>.active:hover>a,.night .ui-toc-dropdown .nav>.active>a{color:#fff;border-left:2px solid #fff}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.night .ui-toc-dropdown .nav>li>a{color:#aaa}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:50px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>a{padding-right:50px}.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:60px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>ul>li>a{padding-right:60px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>a:hover{padding-left:49px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>a:hover{padding-right:49px}.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>ul>li>ul>li>a:hover{padding-left:59px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>ul>li>ul>li>a:hover{padding-right:59px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active>a{padding-left:48px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.active>.nav>.nav>.active>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>.nav>.active:hover>a{padding-right:48px}.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>.nav>.active>.nav>.active>a{padding-left:58px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.active>.nav>.nav>.active>.nav>.active>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>.nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>.nav>.active>.nav>.active:hover>a{padding-right:58px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,"\30D2\30E9\30AE\30CE\89D2\30B4   Pro W3",Osaka,Meiryo,"\30E1\30A4\30EA\30AA",MS Gothic,"\FF2D\FF33   \30B4\30B7\30C3\30AF",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,"\FF2D\FF33   \FF30\30B4\30B7\30C3\30AF",sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,"\5FAE\8EDF\6B63\9ED1",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,"\5FAE\8EDF\6B63\9ED1UI",sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,"\5FAE\8F6F\96C5\9ED1",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,"\5FAE\8F6F\96C5\9ED1UI",sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:rgba(0,0,0,.85)}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}small span{line-height:22px}small .dropdown{display:inline-block}small .dropdown a:focus,small .dropdown a:hover{text-decoration:none}.unselectable{-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}.night .navbar{background:#333;border-bottom-color:#333;color:#eee}.night .navbar a{color:#eee}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid" lang="en"><h1 id="Lab-4---Mongodb"><a class="anchor hidden-xs" href="#Lab-4---Mongodb" title="Lab-4---Mongodb"><i class="fa fa-link"></i></a>Lab 4 - Mongodb</h1><p><strong>Course:</strong> Big Data - IU S24<br>
<strong>Author:</strong> Firas Jolha</p><h2 id="Dataset"><a class="anchor hidden-xs" href="#Dataset" title="Dataset"><i class="fa fa-link"></i></a>Dataset</h2><ul>
<li><a href="https://disk.yandex.com/d/ufcQ3bQD3lJsfw" target="_blank" rel="noopener">sample_mflix_dataset</a>
<ul>
<li>~16MB zipped</li>
<li>~60MB unzipped</li>
</ul>
</li>
</ul><h2 id="Readings"><a class="anchor hidden-xs" href="#Readings" title="Readings"><i class="fa fa-link"></i></a>Readings</h2><ul>
<li><a href="https://www.mongodb.com/docs/v4.2/" target="_blank" rel="noopener">The MongoDB 4.2 Manual</a></li>
</ul><h1 id="Agenda"><a class="anchor hidden-xs" href="#Agenda" title="Agenda"><i class="fa fa-link"></i></a>Agenda</h1><p></p><div class="toc"><ul>
<li><a href="#Lab-4---Mongodb" title="Lab 4 - Mongodb">Lab 4 - Mongodb</a><ul>
<li><a href="#Dataset" title="Dataset">Dataset</a></li>
<li><a href="#Readings" title="Readings">Readings</a></li>
</ul>
</li>
<li><a href="#Agenda" title="Agenda">Agenda</a></li>
<li><a href="#Prerequisites" title="Prerequisites">Prerequisites</a></li>
<li><a href="#Objectives" title="Objectives">Objectives</a></li>
<li><a href="#Introduction" title="Introduction">Introduction</a></li>
<li><a href="#Install-MongoDB" title="Install MongoDB">Install MongoDB</a></li>
<li><a href="#Install-PyMongo-package" title="Install PyMongo package">Install PyMongo package</a></li>
<li><a href="#MongoDB-Databases-and-Collections" title="MongoDB Databases and Collections">MongoDB Databases and Collections</a><ul>
<li><a href="#Arrays-Dot-Notation-and-Embedded-documents" title="Arrays, Dot Notation and Embedded documents">Arrays, Dot Notation and Embedded documents</a></li>
</ul>
</li>
<li><a href="#Data-Description" title="Data Description">Data Description</a></li>
<li><a href="#Build-a-MongoDB-document-store" title="Build a MongoDB document store">Build a MongoDB document store</a></li>
<li><a href="#MongoDB-CRUD-Operations" title="MongoDB CRUD Operations">MongoDB CRUD Operations</a><ul>
<li><a href="#Create-database" title="Create database">Create database</a></li>
<li><a href="#Drop-database" title="Drop database">Drop database</a></li>
<li><a href="#Show-databases" title="Show databases">Show databases</a></li>
<li><a href="#Show-collections" title="Show collections">Show collections</a></li>
<li><a href="#Create-collections" title="Create collections">Create collections</a></li>
<li><a href="#Drop-collections" title="Drop collections">Drop collections</a></li>
<li><a href="#Insert-documents" title="Insert documents">Insert documents</a></li>
<li><a href="#Retrieve-documents" title="Retrieve documents">Retrieve documents</a><ul>
<li><a href="#Select-All-Documents-in-a-Collection" title="Select All Documents in a Collection">Select All Documents in a Collection</a></li>
<li><a href="#Specify-Equality-Condition" title="Specify Equality Condition">Specify Equality Condition</a></li>
<li><a href="#Specify-Conditions-Using-Query-Operators" title="Specify Conditions Using Query Operators">Specify Conditions Using Query Operators</a></li>
<li><a href="#Specify-AND-Conditions" title="Specify AND Conditions">Specify AND Conditions</a></li>
<li><a href="#Specify-OR-Conditions" title="Specify OR Conditions">Specify OR Conditions</a></li>
<li><a href="#Specify-AND-as-well-as-OR-Conditions" title="Specify AND as well as OR Conditions">Specify AND as well as OR Conditions</a></li>
<li><a href="#Query-on-EmbeddedNested-Documents" title="Query on Embedded/Nested Documents">Query on Embedded/Nested Documents</a></li>
<li><a href="#Query-on-Nested-Field" title="Query on Nested Field">Query on Nested Field</a></li>
</ul>
</li>
<li><a href="#Query-operators" title="Query operators">Query operators</a></li>
</ul>
</li>
<li><a href="#Aggregation-operations-in-MongoDB" title="Aggregation operations in MongoDB">Aggregation operations in MongoDB</a><ul>
<li><a href="#Example-with-Inventory-data" title="Example with Inventory data">Example with Inventory data</a><ul>
<li><a href="#Aggregation-pipelines" title="Aggregation pipelines">Aggregation pipelines</a></li>
</ul>
</li>
<li><a href="#Joins" title="Joins">Joins</a></li>
<li><a href="#Text-search" title="Text search">Text search</a><ul>
<li><a href="#Search-for-a-Single-Word" title="Search for a Single Word">Search for a Single Word</a></li>
<li><a href="#Exclude-Documents-That-Contain-a-Term" title="Exclude Documents That Contain a Term">Exclude Documents That Contain a Term</a></li>
<li><a href="#Return-the-Text-Search-Score" title="Return the Text Search Score">Return the Text Search Score</a></li>
<li><a href="#Text-Search-with-Additional-Query-and-Sort-Expressions" title="Text Search with Additional Query and Sort Expressions">Text Search with Additional Query and Sort Expressions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#References" title="References">References</a></li>
</ul>
</div><p></p><h1 id="Prerequisites"><a class="anchor hidden-xs" href="#Prerequisites" title="Prerequisites"><i class="fa fa-link"></i></a>Prerequisites</h1><ul>
<li>Installed Hortonworks Data Platform (HDP) Sandbox</li>
<li>Installed pip and pandas packages</li>
<li>Added Python interpreter to Zeppelin</li>
</ul><h1 id="Objectives"><a class="anchor hidden-xs" href="#Objectives" title="Objectives"><i class="fa fa-link"></i></a>Objectives</h1><ul>
<li>Install MongoDB server on HDP Sandbox</li>
<li>Install MongoDB Compass.</li>
<li>Build a document store (document-oriented database) in MongoDB</li>
<li>Learn how to define collections/documents in MongoDB</li>
<li>Learn how to find data in MongoDB</li>
<li>Learn how to perform aggregations on the data in MongoDB</li>
<li>Import and retrieve data using MongoDB query language</li>
</ul><h1 id="Introduction"><a class="anchor hidden-xs" href="#Introduction" title="Introduction"><i class="fa fa-link"></i></a>Introduction</h1><p>MongoDB is a NoSQL database which stores the data in form of key-value pairs. It is an Open Source, Document Database which provides high performance and scalability along with data modelling and data management of huge sets of data in an enterprise application. A document database stores data in <strong>JSON, BSON, or XML</strong> documents. Documents in the database can be nested. Particular elements can be indexed for faster querying.</p><p>Comparing MongoDB vs. PostgreSQL offers an analysis of MongoDB, the leading distributed NoSQL database, and PostgreSQL (an open source DBMS). Unlike a centralized database, it exists on multiple databases but presents as one. MongoDB also provides the feature of Auto-Scaling. Since, MongoDB is a cross platform database and can be installed across different platforms like Windows, Linux etc.</p><h1 id="Install-MongoDB"><a class="anchor hidden-xs" href="#Install-MongoDB" title="Install-MongoDB"><i class="fa fa-link"></i></a>Install MongoDB</h1><p>You can install MongoDB on the cluster node online via <code>yum</code> (see <a href="https://www.mongodb.com/docs/v4.2/tutorial/install-mongodb-on-red-hat/#install-mongodb-community-edition" target="_blank" rel="noopener">tutorial</a> for more info) or offline via <code>wget</code> and <code>rpm</code>. I recommend the offline installation to avoid any issues with <code>yum</code>. You need to download the packages <em>mongodb-org, mongodb-org-mongos, mongodb-org-server, mongodb-org-shell, mongodb-org-tools</em> for version 4.2.9. I saved the links for you and put them below. You just need to copy the following command line and paste it on your terminal of cluster node then press <em>Enter</em>.</p><pre><code class="wrap powershell hljs">wget https://repo.mongodb.org/yum/redhat/<span class="hljs-number">7</span>/mongodb-org/<span class="hljs-number">4.2</span>/x86_64/RPMS/mongodb-org-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm https://repo.mongodb.org/yum/redhat/<span class="hljs-number">7</span>/mongodb-org/<span class="hljs-number">4.2</span>/x86_64/RPMS/mongodb-org-mongos-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm  https://repo.mongodb.org/yum/redhat/<span class="hljs-number">7</span>/mongodb-org/<span class="hljs-number">4.2</span>/x86_64/RPMS/mongodb-org-server-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm  https://repo.mongodb.org/yum/redhat/<span class="hljs-number">7</span>/mongodb-org/<span class="hljs-number">4.2</span>/x86_64/RPMS/mongodb-org-shell-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm https://repo.mongodb.org/yum/redhat/<span class="hljs-number">7</span>/mongodb-org/<span class="hljs-number">4.2</span>/x86_64/RPMS/mongodb-org-tools-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm
</code></pre><p>After downloading the packages, you need to install them via <code>rpm</code> as follows:</p><pre><code class="wrap powershell hljs">rpm -i --force mongodb-org-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm mongodb-org-server-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm mongodb-org-shell-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm mongodb-org-mongos-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm mongodb-org-tools-<span class="hljs-number">4.2</span>.<span class="hljs-number">9</span>-<span class="hljs-number">1</span>.el7.x86_64.rpm  
</code></pre><div class="alert alert-warning">
<p>If you tried installing more recent versions of MongoDB, you may get some errors. For instance, the version 4.4 has some conflicting dependencies and it is not recommended whereas the version 5.0 requires VT-x enabled CPU where the virtualization instruction should be enabled for the Docker container.</p>
<p>There is also another way to install MongoDB on the cluster node which is via the open source tool published in the repository as follows.</p>
<pre><code class="wrap powershell hljs">git clone https://github.com/nikunjness/mongo-ambari.git
</code></pre>
<p>This open source tool is quite old and will install MongoDB version 3.2 but it allows to add MongoDB as a service to the Ambari dashboard where management and configuration could be easier but it is not a big deal.</p>
</div><p>MongoDB will come with several tools for database management such as <code>mongo</code> or <code>mongosh</code> for running MongoDB Shell, <code>mongoimport</code> for importing files into MongoDB databases, and <code>mongodump</code> for dumping the database.</p><p><img src="https://i.imgur.com/q9LlXgH.png" alt="" width="1000" height="30" class="md-image md-image"></p><div class="alert alert-info">
<p><code>mongosh</code> is the new name given to MongoDB shell in recent versions whereas the old versions use the name <code>mongo</code>.</p>
</div><h1 id="Install-PyMongo-package"><a class="anchor hidden-xs" href="#Install-PyMongo-package" title="Install-PyMongo-package"><i class="fa fa-link"></i></a>Install PyMongo package</h1><p>You can work with MongoDB databases directly using the shell <code>mongo</code>/<code>mongosh</code> but MongoDB provides official driver libraries for multiple programming langauges including Python where performing operations on the databases will be more flexible and easier, since you are familiar with Python and can utilize other packages for data manipulation such as <code>pandas</code>. We will use the official package <code>pymongo</code> version <em>3.13.0</em> which can be installed via <code>pip</code> as follows:</p><pre><code class="sh hljs">pip2 <span class="hljs-keyword">install</span> pymongo
</code></pre><p><code>pip2</code> will install the latest version <em>(3.13.0)</em> for Python 2 whereas the latest version of the library for Python 3 is <em>4.3.3</em>. If you would like to try it, you can try to install it on your local machine but for this lab’s purposes you need to install the package on the cluster node.</p><div class="alert alert-info">
<p>If you added Python interpreter to Zeppelin, then you can immediately create a notebook and start working on <code>pymongo</code>.</p>
</div><h1 id="MongoDB-Databases-and-Collections"><a class="anchor hidden-xs" href="#MongoDB-Databases-and-Collections" title="MongoDB-Databases-and-Collections"><i class="fa fa-link"></i></a>MongoDB Databases and Collections</h1><p>In MongoDB, databases hold collections of documents. MongoDB stores documents in collections. Collections are analogous to tables and documents to records in relational databases. If a database does not exist, MongoDB creates the database when you first store data for it. In the same way, if a collection does not exist, MongoDB creates the collection when you first store data for it.</p><p><img src="https://i.imgur.com/Zt9JbPB.png" alt="" class="md-image md-image"></p><center>
<img src="https://i.imgur.com/15fxn4F.png" width="400">
<p> A collection in MongoDB
</p>
</center><p>Document in MongoDB is nothing but the set of key-value pairs. These documents will have dynamic schema which means that the documents in the same collection do not need to possess the same set of fields.</p><p>Since MongoDB is considered as a schema-less database, each collection can hold different type of objects. Every object in a collection is known as Document, which is represented in a JSON like (JavaScript Object Notation) structure. Data is stored and queried in <strong>BSON</strong>. BSON is a binary representation of JSON documents, though it contains more data types than JSON. MongoDB documents are composed of field-and-value pairs. The value of a field can be any of the BSON <a href="https://www.mongodb.com/docs/v4.2/reference/bson-types/" target="_blank" rel="noopener">data types</a>, including other documents, arrays, and arrays of documents.</p><center>
<img src="https://i.imgur.com/Pu5pJMJ.png" width="400">
<p> A document in MongoDB
</p>
</center><p>The following document contains 6 fields, including <code>_id</code> of type <a href="https://www.mongodb.com/docs/v4.2/reference/bson-types/#objectid" target="_blank" rel="noopener"><code>ObjectId</code></a>, <code>name</code> holds an <strong>embedded document</strong> that contains the fields <code>first</code> and <code>last</code>, <code>birth</code> and <code>death</code> hold values of the <em>Date</em> type, <code>contribs</code> holds an array of strings, and <code>views</code> holds a value of the <em>NumberLong</em> type.</p><pre><code class="go hljs"><span class="token keyword">var</span> mydoc <span class="token operator">=</span> <span class="token punctuation">{</span>
               _id<span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"5099803df3f4948bd2f98391"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               name<span class="token punctuation">:</span> <span class="token punctuation">{</span> first<span class="token punctuation">:</span> <span class="token string">"Alan"</span><span class="token punctuation">,</span> last<span class="token punctuation">:</span> <span class="token string">"Turing"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
               birth<span class="token punctuation">:</span> <span class="token builtin">new</span> <span class="token function">Date</span><span class="token punctuation">(</span>'Jun <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1912</span>'<span class="token punctuation">)</span><span class="token punctuation">,</span>
               death<span class="token punctuation">:</span> <span class="token builtin">new</span> <span class="token function">Date</span><span class="token punctuation">(</span>'Jun <span class="token number">07</span><span class="token punctuation">,</span> <span class="token number">1954</span>'<span class="token punctuation">)</span><span class="token punctuation">,</span>
               contribs<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"Turing machine"</span><span class="token punctuation">,</span> <span class="token string">"Turing test"</span><span class="token punctuation">,</span> <span class="token string">"Turingery"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
               views <span class="token punctuation">:</span> <span class="token function">NumberLong</span><span class="token punctuation">(</span><span class="token number">1250000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
</code></pre><p>Field names are strings. The field name <code>_id</code> is reserved for use as a primary key; its value must be unique in the collection, is immutable, and may be of any type other than an array, it is a combination of machine identifier, timestamp and process id to keep it unique, but user can changes it to anything. Field names cannot contain the null character. MongoDB uses the dot notation to access the elements of an array and to access the fields of an embedded document.</p><div class="alert alert-warning">
<p><strong>Query filter documents</strong> are documents used specially in <code>db.collection.find</code> method (equivalent to SELECT in SQL) to specify the conditions that determine which records to select for read, update, and delete operations. You can use <code>&lt;field&gt;:&lt;value&gt;</code> expressions to specify the equality condition and query operator expressions.</p>
<pre><code class="go hljs"><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>value1<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token operator">&lt;</span>field2<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>operator<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
</div><h2 id="Arrays-Dot-Notation-and-Embedded-documents"><a class="anchor hidden-xs" href="#Arrays-Dot-Notation-and-Embedded-documents" title="Arrays-Dot-Notation-and-Embedded-documents"><i class="fa fa-link"></i></a>Arrays, Dot Notation and Embedded documents</h2><p>MongoDB uses the dot notation to access the elements of an array and to access the fields of an embedded document. For example, you access the field <code>views</code> for the previous document as <code>mydoc</code><strong>.</strong><code>views</code>. To specify or access an element of an array by the zero-based index position, concatenate the array name with the dot (.) and zero-based index position, and enclose in quotes.</p><pre><code class="go hljs"><span class="token string">"&lt;array&gt;.&lt;index&gt;"</span>
</code></pre><p>To specify the third element in the <code>contribs</code> array, use the dot notation <code>"contribs.2"</code>.</p><p>To specify or access a field of an embedded document with dot notation, concatenate the embedded document name with the dot (.) and the field name, and enclose in quotes:</p><pre><code class="go hljs"><span class="token string">"&lt;embedded document&gt;.&lt;field&gt;"</span>
</code></pre><p>For example, given the following field in a document:</p><pre><code class="go hljs"><span class="token punctuation">{</span>
   <span class="token operator">...</span>
   name<span class="token punctuation">:</span> <span class="token punctuation">{</span> first<span class="token punctuation">:</span> <span class="token string">"Alan"</span><span class="token punctuation">,</span> last<span class="token punctuation">:</span> <span class="token string">"Turing"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   contact<span class="token punctuation">:</span> <span class="token punctuation">{</span> phone<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">"cell"</span><span class="token punctuation">,</span> number<span class="token punctuation">:</span> <span class="token string">"111-222-3333"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><p>To specify the number in the phone document in the <code>contact</code> field, use the dot notation <code>"contact.phone.number"</code>.</p><div class="alert alert-warning">
<p>The maximum BSON document size is 16 megabytes. To store documents larger than the that, MongoDB provides the <a href="https://www.mongodb.com/docs/v4.2/core/gridfs/" target="_blank" rel="noopener">GridFS API</a> which is about dividing the large file into parts or chunks and storing each chunk as a separate document.</p>
</div><div class="alert alert-warning">
<p>The fields in a BSON document are ordered. For example, <code>{a: 1, b: 1}</code> is not equal to <code>{b: 1, a: 1}</code>.</p>
</div><h1 id="Data-Description"><a class="anchor hidden-xs" href="#Data-Description" title="Data-Description"><i class="fa fa-link"></i></a>Data Description</h1><p>The <code>sample_mflix</code> dataset contains data on movies and movie theaters. The dataset also contains certain metadata, including users and comments on specific movies. In this lab, we will work on <a href="https://www.mongodb.com/docs/atlas/sample-data/sample-mflix/" target="_blank" rel="noopener"><code>sample_mflix</code></a> dataset from MongoDB website.</p><center>
<img src="https://i.imgur.com/3UwL0kY.png" width="200">
<p> A fake image of Mflix brand
</p>
</center><p>The dataset consists of 5 <code>.json</code> files where each file will be loaded to create a <strong><code>collection</code></strong> and each line corresponds to a <strong><code>document</code></strong> in the collection. These files are dumped from a MongoDB database and the data is stored as Extended JSON v2.0. This format is introduced in MongoDB to preserve the datatypes and attributes of certain fields when converting from BSON to JSON. There is also Extended JSON v1.0 which is used in MongoDB versions before 4.2 and supports less  datatypes than v2.0. You can read more info about MongoDB Extended JSON v2.0 from <a href="https://www.mongodb.com/docs/manual/reference/mongodb-extended-json/" target="_blank" rel="noopener">here</a>. You can see the Extended JSON v2.0 in the files by checking the fields which start with the symbol <strong>$</strong>. For example:</p><pre><code class="python hljs">{<span class="hljs-string">"theaterId"</span>:{<span class="hljs-string">"$numberInt"</span>:<span class="hljs-string">"1000"</span>}}
</code></pre><p><code>theaterId</code> here is a field and has the value 1000 as an integer type.</p><div class="alert alert-info">
<p>When you use <code>mongoimport</code> v4.2 for loading the data to MongoDB, the datatypes in extended JSON format will be automatically translated into corresponding types in MongoDB. If you are using older versions of <code>mongoimport</code> then some datatypes will not be translated properly since the older versions support only Extended JSON v1.0.</p>
</div><p>The description of the dataset is presented in the following table.</p><table>
<thead>
<tr>
<th>File Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>users.json</td>
<td>This collection contains information on mflix users. Each line/document contains a single user, and their name, email, and password. The fields are <code>_id</code> as the primary key in the collection, <code>name</code> as name of the user, <code>email</code> has the unique property, and <code>password</code> field which contains the user password.</td>
</tr>
<tr>
<td>movies.json</td>
<td>This collection contains details on movies. Each document contains a single movie, and information such as its title, release year, and cast.</td>
</tr>
<tr>
<td>theaters.json</td>
<td>This collection contains movie theater locations. Each document contains a single movie theater and its location in both string and GeoJSON forms.</td>
</tr>
<tr>
<td>sessions.json</td>
<td>This collection contains metadata about  users. Each document contains a user and their corresponding JSON Web Token</td>
</tr>
<tr>
<td>comments.json</td>
<td>This collection contains comments associated with specific movies. Each document contains the comment text, the user who submitted it, and the movie the comment applies to.</td>
</tr>
</tbody>
</table><p>For more information on the dataset, you can look at <a href="https://www.mongodb.com/docs/atlas/sample-data/sample-mflix/#sample_mflix.comments" target="_blank" rel="noopener">here</a>.</p><h1 id="Build-a-MongoDB-document-store"><a class="anchor hidden-xs" href="#Build-a-MongoDB-document-store" title="Build-a-MongoDB-document-store"><i class="fa fa-link"></i></a>Build a MongoDB document store</h1><p>You can build a document store by inserting some data in it. In this lab, we will use the sample dataset from the official website. The dataset is <code>sample_mflix</code>. It consists of 5 <em>Json</em> files.</p><div class="alert alert-success">
<p><strong>Exercises on MongoDB</strong></p>
<ol>
<li>Download the dataset folder <code>sample_mflix</code>. Unzip it and copy the files to the folder <code>/sample_mflix</code> in the cluster node via <code>scp</code> or <code>docker cp</code>.</li>
<li>Import all data to the database <code>mflixdb</code> via <code>mongoimport</code> tool (Note: You do not need to create a database or a collection in advance). For example, to import <em>comments</em> data from <code>comments.json</code> to the database, you can run the following command:</li>
</ol>
<p><strong>Note:</strong> For running multiline command in Windows Powershell, replace the slash (\) with the backtick (`).</p>
<pre><code class="wrap powershell hljs">mongoimport --db mflixdb \
            --collection comments \
            --file comments.json
</code></pre>
<p><strong>Note:</strong> The default porrt for the previous connection is 27017. If your server is running on a different port, you can specify the host and the port via options <code>--host</code> and <code>--port</code>.</p>
<p>Similarly, import the data from other files. Eventually, you will create 5 collections in the database which are <em>[“comments”, “sessions”, “movies”, “theaters”, “users”]</em>.</p>
<pre><code class="wrap powershell hljs">mongoimport --db mflixdb --collection sessions --file sessions.json

mongoimport --db mflixdb --collection movies --file movies.json

mongoimport --db mflixdb --collection theaters --file theaters.json

mongoimport --db mflixdb --collection users --file users.json
</code></pre>
<p><strong>Note:</strong> If the json file includes an array as the root element then you need to add the option <code>--jsonArray</code>. The option <code>--headerline</code> is useful for accepting the first line in the file as field list in <code>csv</code> and <code>tsv</code> files. You can find more options for the tool <code>mongoimport</code> by running the command line <code>mongoimport --help</code>.</p>
<ol start="3">
<li>Access the database from the shell <code>mongo/mongosh</code> or from via <code>pymongo</code>. To access the database <code>mflixdb</code> from <code>mongo</code>, you can write in <code>mongo</code> as follows:</li>
</ol>
<pre><code class="sh hljs"> &gt; <span class="hljs-keyword">use</span> mflixdb
 switched <span class="hljs-keyword">to</span> db mflixdb
</code></pre>
<p>In the <code>mongo/mongosh</code> shell, <code>db</code> is the variable that references the current database. The variable is automatically set to the default database <code>test</code> when you access the shell or is set when you use the <code>use &lt;db&gt;</code> to switch current database.</p>
<ol start="4">
<li>You can list all collections in the database as follows.</li>
</ol>
<pre><code class="go hljs"> <span class="token operator">&gt;</span> db<span class="token punctuation">.</span><span class="token function">getCollectionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ol start="5">
<li>You can list the first 10 theaters as follows.</li>
</ol>
<pre><code class="go hljs"><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>theaters<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
<p>OR</p>
<pre><code class="go hljs"><span class="token operator">&gt;</span> db<span class="token punctuation">[</span><span class="token char">'theaters'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
</div><h1 id="MongoDB-CRUD-Operations"><a class="anchor hidden-xs" href="#MongoDB-CRUD-Operations" title="MongoDB-CRUD-Operations"><i class="fa fa-link"></i></a>MongoDB CRUD Operations</h1><p>CRUD operations include create, read, update, and delete documents. All examples here are provided for <code>monog/mongosh</code> shell. Adapting them to other programming language like Python is not difficult in case you decided to use <code>PyMongo</code> package.</p><div class="alert alert-warning">
<p>The apparent difference between <code>mongo</code> shell and <code>pymongo</code>, is that <code>pymongo</code> uses snake_case for method names such as <code>db.collection.insert_many()</code> whereas<code>mongo</code> shell uses camelCase such as <code>db.collection.insertMany()</code>.</p>
</div><h2 id="Create-database"><a class="anchor hidden-xs" href="#Create-database" title="Create-database"><i class="fa fa-link"></i></a>Create database</h2><p>If a database does not exist, MongoDB creates the database when you first store data for that database. If a database already exists with the mentioned name, then it just connects to that database.</p><pre><code class="wrap javascript hljs">use &lt;database_name&gt;
</code></pre><h2 id="Drop-database"><a class="anchor hidden-xs" href="#Drop-database" title="Drop-database"><i class="fa fa-link"></i></a>Drop database</h2><p>Before deleting the database, connect to the required database which is to be deleted. The default database when you access the shell is <code>test</code>.</p><pre><code class="wrap javascript hljs">db.dropDatabase()
</code></pre><h2 id="Show-databases"><a class="anchor hidden-xs" href="#Show-databases" title="Show-databases"><i class="fa fa-link"></i></a>Show databases</h2><p>You can check the databases in the current DBMS instance as follows: (By default mongodb has no enabled access control, so there is no default user or password)</p><pre><code class="wrap javascript hljs">show databases
</code></pre><h2 id="Show-collections"><a class="anchor hidden-xs" href="#Show-collections" title="Show-collections"><i class="fa fa-link"></i></a>Show collections</h2><p>You can check the collections in the connected database as follows:</p><pre><code class="wrap javascript hljs">show collections
</code></pre><h2 id="Create-collections"><a class="anchor hidden-xs" href="#Create-collections" title="Create-collections"><i class="fa fa-link"></i></a>Create collections</h2><pre><code class="wrap javascript hljs"><span class="hljs-comment">// db.createCollection(name, options)</span>

db.createCollection(<span class="hljs-string">"student"</span>, { <span class="hljs-attr">capped</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">size</span> : <span class="hljs-number">5242880</span>, <span class="hljs-attr">max</span> : <span class="hljs-number">5000</span> } )
</code></pre><p>This will create a collection named student, with maximum size of 5 mebibytes and maximum of 5000 documents.</p><div class="alert alert-warning">
<p>If a collection is capped and reaches its maximum size limit, MongoDB then removes older documents from it to make space for new.</p>
</div><h2 id="Drop-collections"><a class="anchor hidden-xs" href="#Drop-collections" title="Drop-collections"><i class="fa fa-link"></i></a>Drop collections</h2><pre><code class="wrap javascript hljs"><span class="hljs-comment">// db.collection_name.drop()</span>

db.student.drop()
</code></pre><p><code>drop</code> method will return true is the collection is dropped successfully, else it will return false.</p><h2 id="Insert-documents"><a class="anchor hidden-xs" href="#Insert-documents" title="Insert-documents"><i class="fa fa-link"></i></a>Insert documents</h2><p>MongoDB provides the following methods to insert documents into a collection:</p><ul>
<li>db.collection.insertOne()</li>
<li>db.collection.insertMany()</li>
</ul><p>To insert a single document:</p><center>
<img src="https://i.imgur.com/WFs3pUC.png" width="400">
<p> Insert a single document in <b>users</b> collection
</p>
</center><p>To insert many documents:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"journal"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"blank"</span><span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"mat"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">,</span> tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"gray"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">27.9</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">35.5</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"mousepad"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"gel"</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">22.85</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="alert alert-danger">
<p>In MongoDB, each document stored in a collection requires a unique <code>_id</code> field that acts as a primary key. If an inserted document omits the <code>_id</code> field, the MongoDB driver automatically generates an <code>ObjectId</code> for the <code>_id</code> field.</p>
</div><h2 id="Retrieve-documents"><a class="anchor hidden-xs" href="#Retrieve-documents" title="Retrieve-documents"><i class="fa fa-link"></i></a>Retrieve documents</h2><p>You can query documents in MongoDB via the method <a href="https://www.mongodb.com/docs/v4.2/reference/method/db.collection.find/#db.collection.find" target="_blank" rel="noopener"><code>db.collection.find(query, projection)</code></a>. It has the following syntax:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token operator">&lt;</span>query<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>projection<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>options<span class="token operator">&gt;</span> <span class="token punctuation">)</span>
</code></pre><p>Given the following <code>inventory</code> collection:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"journal"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"notebook"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">8.5</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"in"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"paper"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">8.5</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"in"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token string">"D"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"planner"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">75</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">22.85</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token string">"D"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token string">"postcard"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token number">45</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">15.25</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Let’s run the following queries.</p><h3 id="Select-All-Documents-in-a-Collection"><a class="anchor hidden-xs" href="#Select-All-Documents-in-a-Collection" title="Select-All-Documents-in-a-Collection"><i class="fa fa-link"></i></a>Select All Documents in a Collection</h3><p>To select all documents in the collection, pass an empty document as the query filter parameter to the find method. The query filter parameter determines the select criteria. For example, to select all inventory data without any specific criteria:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>The equivalent SQL statement is:</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory
</code></pre><h3 id="Specify-Equality-Condition"><a class="anchor hidden-xs" href="#Specify-Equality-Condition" title="Specify-Equality-Condition"><i class="fa fa-link"></i></a>Specify Equality Condition</h3><p>To specify equality conditions, use <code>&lt;field&gt;:&lt;value&gt;</code> expressions in the query filter document in the following form:</p><pre><code class="go hljs"><span class="token punctuation">{</span> <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>value1<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><p>For example, to select all inventory whose status is “D”:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> status <span class="token punctuation">:</span> <span class="token string">"D"</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>The equivalent SQL statement is:</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">"D"</span>
</code></pre><h3 id="Specify-Conditions-Using-Query-Operators"><a class="anchor hidden-xs" href="#Specify-Conditions-Using-Query-Operators" title="Specify-Conditions-Using-Query-Operators"><i class="fa fa-link"></i></a>Specify Conditions Using Query Operators</h3><p>MongoDB provides several <a href="https://www.mongodb.com/docs/v4.2/reference/operator/query/#query-selectors" target="_blank" rel="noopener">query operators</a> to specify conditions on the retrieved data  in the following form:</p><pre><code class="go hljs"><span class="token punctuation">{</span> <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>operator1<span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>value1<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><p>For example, to retrieve all documents from the inventory collection where status equals either “A” or “D”:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token punctuation">{</span> $in<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"D"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>Equivalently in SQL.</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">"A"</span>, <span class="hljs-string">"D"</span>)
</code></pre><h3 id="Specify-AND-Conditions"><a class="anchor hidden-xs" href="#Specify-AND-Conditions" title="Specify-AND-Conditions"><i class="fa fa-link"></i></a>Specify AND Conditions</h3><p>A compound query can specify conditions for more than one field in the collection’s documents. Implicitly, a logical AND conjunction connects the clauses of a compound query so that the query selects the documents in the collection that match all the conditions. For example, to retrieve all documents in the inventory collection where the status equals “A” and qty is less than (<code>$lt</code>) 30:</p><details><summary>MongoDB</summary>
<pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> qty<span class="token punctuation">:</span> <span class="token punctuation">{</span> $lt<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre>
</details><p>The operation corresponds to the following SQL statement:</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">"A"</span> <span class="hljs-keyword">AND</span> qty &lt; <span class="hljs-number">30</span>
</code></pre><h3 id="Specify-OR-Conditions"><a class="anchor hidden-xs" href="#Specify-OR-Conditions" title="Specify-OR-Conditions"><i class="fa fa-link"></i></a>Specify OR Conditions</h3><p>Using the <code>$or</code> operator, you can specify a compound query that joins each clause with a logical OR conjunction so that the query selects the documents in the collection that match at least one condition. The following example retrieves all documents in the collection where the status equals “A” or qty is less than (<code>$lt</code>) 30:</p><details><summary>MongoDB</summary>
<pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> $or<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> qty<span class="token punctuation">:</span> <span class="token punctuation">{</span> $lt<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre>
</details><p>The operation corresponds to the following SQL statement:</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">"A"</span> <span class="hljs-keyword">OR</span> qty &lt; <span class="hljs-number">30</span>
</code></pre><h3 id="Specify-AND-as-well-as-OR-Conditions"><a class="anchor hidden-xs" href="#Specify-AND-as-well-as-OR-Conditions" title="Specify-AND-as-well-as-OR-Conditions"><i class="fa fa-link"></i></a>Specify AND as well as OR Conditions</h3><p>In the following example, the compound query document selects all documents in the collection where the status equals “A” and either qty is less than ($lt) 30 or item starts with the character p:</p><details><summary>MongoDB</summary>
<pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
     status<span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span>
     $or<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> qty<span class="token punctuation">:</span> <span class="token punctuation">{</span> $lt<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> item<span class="token punctuation">:</span> <span class="token operator">/</span><span class="token operator">^</span>p<span class="token operator">/</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre>
</details><p>The operation corresponds to the following SQL statement:</p><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> inventory <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">"A"</span> <span class="hljs-keyword">AND</span> ( qty &lt; <span class="hljs-number">30</span> <span class="hljs-keyword">OR</span> item <span class="hljs-keyword">LIKE</span> <span class="hljs-string">"p%"</span>)
</code></pre><div class="alert alert-info">
<p>The <code>db.collection.findOne()</code> is another method which performs a read operation to return a single document. Internally, the <code>db.collection.findOne()</code> method is the <code>db.collection.find()</code> method with a limit of <code>1</code>.</p>
</div><h3 id="Query-on-EmbeddedNested-Documents"><a class="anchor hidden-xs" href="#Query-on-EmbeddedNested-Documents" title="Query-on-EmbeddedNested-Documents"><i class="fa fa-link"></i></a>Query on Embedded/Nested Documents</h3><p>To specify an equality condition on a field that is an embedded/nested document, use the query filter document <code>{ &lt;field&gt;: &lt;value&gt; }</code> where <code>&lt;value&gt;</code> is the document to match.</p><p>For example, the following query selects all documents where the field size equals the document <code>{ h: 14, w: 21, uom: "cm" }</code>:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> h<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>Equality matches on the whole embedded document require an <strong>exact match</strong> of the specified <code>&lt;value&gt;</code> document, including the <strong>field order</strong>. For example, the following query <strong>does not</strong> match any documents in the inventory collection:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>  <span class="token punctuation">{</span> size<span class="token punctuation">:</span> <span class="token punctuation">{</span> w<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span> h<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">,</span> uom<span class="token punctuation">:</span> <span class="token string">"cm"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>  <span class="token punctuation">)</span>
</code></pre><h3 id="Query-on-Nested-Field"><a class="anchor hidden-xs" href="#Query-on-Nested-Field" title="Query-on-Nested-Field"><i class="fa fa-link"></i></a>Query on Nested Field</h3><p>To specify a query condition on fields in an embedded/nested document, use dot notation <code>("field.nestedField")</code>.</p><div class="alert alert-warning">
<p>When querying using dot notation, the field and nested field must be inside <em>“quotation marks”</em>.</p>
</div><p>The following example selects all documents where the field uom nested in the size field equals <code>"in"</code>:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">"size.uom"</span><span class="token punctuation">:</span> <span class="token string">"in"</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>Or maybe you would like to search using query operators to specify conditions. For example, to retrieve the inventory items whose height is less than 15:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">"size.h"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> $lt<span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><div class="alert alert-success">
<p><strong>Exercises on MongoDB</strong></p>
<ul>
<li>Retrieve all theaters</li>
</ul>
<pre><code class="javascript hljs"><span class="hljs-comment">// db.theaters.find(filter, projection)</span>
db.theaters.find({})
db.theaters.find()
</code></pre>
<ul>
<li>Retrieve first 3 theaters which are located in states ends with letter A and the zip code is greater than 90000. Retrieve only location and theaterId.</li>
</ul>
<details><summary>Solution</summary>
<pre><code class="wrap javascript hljs">db.theaters.find(
    {
        <span class="hljs-string">"location.address.state"</span>: {
            <span class="hljs-attr">$regex</span> : <span class="hljs-string">"A$"</span>
        },
        <span class="hljs-attr">$expr</span>: {
            <span class="hljs-attr">$gt</span>: [<span class="hljs-string">"location.address.zipcode"</span>, <span class="hljs-number">90000</span>]
        } 
    },
    {
        <span class="hljs-attr">location</span> : <span class="hljs-literal">true</span>,
        <span class="hljs-attr">theaterId</span> : <span class="hljs-literal">true</span>,
        <span class="hljs-attr">_id</span> : <span class="hljs-literal">false</span>
    }
).limit(<span class="hljs-number">3</span>)
</code></pre>
</details>
</div><h2 id="Query-operators"><a class="anchor hidden-xs" href="#Query-operators" title="Query-operators"><i class="fa fa-link"></i></a>Query operators</h2><div class="alert alert-success">
<h3 id="Comparison-operators"><a class="anchor hidden-xs" href="#Comparison-operators" title="Comparison-operators"><i class="fa fa-link"></i></a>Comparison operators</h3>
<ul>
<li>Retrieve all movies which belong to drama or crime generes and number of comments <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2265;</mo><mn>100</mn></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 2.966em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.535em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.565em, 1002.48em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mo" id="MathJax-Span-3" style="font-family: MathJax_Main;">≥</span><span class="mn" id="MathJax-Span-4" style="font-family: MathJax_Main; padding-left: 0.272em;">100</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>≥</mo><mn>100</mn></math></span></span><script type="math/tex" id="MathJax-Element-1">\ge 100</script></span> and it is not filmed in USA and the type of show is movie. Retrieve the countries.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.find(
    {
        <span class="hljs-attr">genres</span>: {
            <span class="hljs-attr">$in</span>:[<span class="hljs-string">"Drama"</span>, <span class="hljs-string">"Crime"</span>]
        }, 
        <span class="hljs-attr">num_mflix_comments</span>: {
            <span class="hljs-attr">$gte</span>: <span class="hljs-number">100</span>
        }, 
        <span class="hljs-attr">countries</span>: {
            <span class="hljs-attr">$nin</span>: [<span class="hljs-string">"USA"</span>] 
        }, 
        <span class="hljs-attr">type</span>: {
            <span class="hljs-attr">$eq</span>:<span class="hljs-string">"movie"</span>
        }
    }, 
    {<span class="hljs-attr">countries</span>:<span class="hljs-number">1</span>}
)
</code></pre>
<h3 id="Logical-operators"><a class="anchor hidden-xs" href="#Logical-operators" title="Logical-operators"><i class="fa fa-link"></i></a>Logical operators</h3>
<ul>
<li>Retrieve all movies which belong to drama genre or (number of comments <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2265;</mo><mn>100</mn></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-5" style="width: 2.966em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.535em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.565em, 1002.48em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-6"><span class="mo" id="MathJax-Span-7" style="font-family: MathJax_Main;">≥</span><span class="mn" id="MathJax-Span-8" style="font-family: MathJax_Main; padding-left: 0.272em;">100</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.066em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>≥</mo><mn>100</mn></math></span></span><script type="math/tex" id="MathJax-Element-2">\ge 100</script></span> and it is not filmed in USA). Retrieve every field except _id and awards.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.find(
    {
        <span class="hljs-attr">$or</span>: [
            {
                <span class="hljs-attr">genres</span>: {
                    <span class="hljs-attr">$in</span>: [<span class="hljs-string">"Drama"</span>]
                }
            }, 
            {
                <span class="hljs-attr">$and</span> : [
                {
                    <span class="hljs-attr">num_mflix_comments</span>: {
                        <span class="hljs-attr">$gte</span>: <span class="hljs-number">100</span>
                    }
                },
                {
                    <span class="hljs-attr">countries</span>: 
                    {
                        {
                        <span class="hljs-attr">$not</span>:{<span class="hljs-attr">$in</span>: [<span class="hljs-string">"USA"</span>]}
                        }
                    }
                }
            ]
            }
        ]
    }, 
    {<span class="hljs-attr">_id</span>:<span class="hljs-literal">false</span>, <span class="hljs-attr">awards</span>:<span class="hljs-literal">false</span>}
).limit(<span class="hljs-number">3</span>)
</code></pre>
<h3 id="Element-operators"><a class="anchor hidden-xs" href="#Element-operators" title="Element-operators"><i class="fa fa-link"></i></a>Element operators</h3>
<ul>
<li>Retrieve all theaters which has street2 in its address field and the datatype of the field x corrdinates is <code>number</code>. Retrieve the number of theaters which satisfy this condition.</li>
</ul>
<pre><code class="wrap javascript hljs">db.theaters.find(
    {
        <span class="hljs-string">"location.address.street2"</span>:{
            <span class="hljs-attr">$exists</span>:<span class="hljs-literal">true</span>
        },
        <span class="hljs-string">"location.geo.coordinates.0"</span>:{
            <span class="hljs-attr">$type</span>: <span class="hljs-string">"number"</span>
        }
    }
).count()
</code></pre>
<p><strong>Note:</strong> You can get the datatype of a specific column in MongoDB Shell by running the command <code>typeof &lt;object&gt;</code>. For example:</p>
<pre><code class="wrap javascript hljs"><span class="hljs-keyword">typeof</span> db.theaters.findOne().location.geo.coordinates[<span class="hljs-number">0</span>]
</code></pre>
<p><img src="https://i.imgur.com/380uP5Q.png" alt="" class="md-image md-image"></p>
<h3 id="Evaluation-operators"><a class="anchor hidden-xs" href="#Evaluation-operators" title="Evaluation-operators"><i class="fa fa-link"></i></a>Evaluation operators</h3>
<p>We have 6 operators here, the most commonly used ones are <code>$expr</code>, <code>$text</code>, and <code>$regex</code>.</p>
<p><code>$expr</code> allows the use of aggregation expressions within the query language. It has the following syntax:<br>
<code>{ $expr: { &lt;expression&gt; } }</code><br>
The arguments can be any valid aggregation expression.</p>
<p>Example:</p>
<pre><code class="wrap javascript hljs">db.theaters.find(
    {
        <span class="hljs-string">"location.address.zipcode"</span>:{
            <span class="hljs-attr">$exists</span>:<span class="hljs-literal">true</span>
        },
        <span class="hljs-string">"location.address.state"</span>: {
            <span class="hljs-attr">$regex</span> : <span class="hljs-regexp">/^A/</span>
        }, 
        <span class="hljs-string">"$expr"</span>: {
            <span class="hljs-string">"$gt"</span>: 
            [
                {
                    <span class="hljs-string">"$convert"</span>:{
                        <span class="hljs-attr">input</span>: <span class="hljs-string">"location.address.zipcode"</span>, 
                        <span class="hljs-attr">to</span>: <span class="hljs-string">"decimal"</span>, <span class="hljs-attr">onError</span>:<span class="hljs-string">""</span>, <span class="hljs-attr">onNull</span>:<span class="hljs-string">""</span>
                    }
                }, 
                <span class="hljs-number">90000</span>
            ]
        }
    }, 
    {<span class="hljs-attr">_id</span>:<span class="hljs-literal">false</span>}
).count()
</code></pre>
<p><strong>Note:</strong> For the operator <code>$text</code>, you need to create a text index.</p>
<ul>
<li>Create a text index on the fields “street1”, “city”, and “state”.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.createIndex(
    {
        <span class="hljs-attr">title</span>: <span class="hljs-string">"text"</span>, 
        <span class="hljs-attr">plot</span>: <span class="hljs-string">"text"</span>
    }
)
</code></pre>
<ul>
<li>Retrieve all movies which contain the sentence “card game”, and does not contain any of the words “money”, “friend”, and “criminal”. Sort the results according to the score of the match.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.find(
    {
        <span class="hljs-attr">$text</span>:{
            <span class="hljs-attr">$search</span>:<span class="hljs-string">"\"card game\" -money -friend -criminal"</span>
        }
    }, 
    {
        <span class="hljs-attr">score</span>:{
            <span class="hljs-attr">$meta</span>:<span class="hljs-string">"textScore"</span>
        }, 
        <span class="hljs-attr">title</span>:<span class="hljs-literal">true</span>, 
        <span class="hljs-attr">plot</span>: <span class="hljs-literal">true</span>
    }
)
</code></pre>
<p><img src="https://i.imgur.com/hfNenZD.png" alt="" class="md-image md-image"></p>
<p>You can visit <a href="https://ananya281294.medium.com/mongo-maths-676469e55f78" target="_blank" rel="noopener">this tutorial</a> for checking the score calculation formula.</p>
<h3 id="Array-operators"><a class="anchor hidden-xs" href="#Array-operators" title="Array-operators"><i class="fa fa-link"></i></a>Array operators</h3>
<p>Array operators return data based on array conditions. The <code>$all</code> operator selects the documents where the value of a field is an array that contains all the specified elements.</p>
<pre><code class="wrap javascript hljs">db.movies.find(
    {
        <span class="hljs-attr">genres</span>:{
            <span class="hljs-attr">$all</span>:[<span class="hljs-string">'Action'</span>, <span class="hljs-string">'Comedy'</span>, <span class="hljs-string">'Drama'</span>]
        }, 
        <span class="hljs-attr">countries</span>: {
            <span class="hljs-attr">$elemMatch</span>:{
                <span class="hljs-attr">$eq</span>:<span class="hljs-string">"Canada"</span>
            }
        }, 
        <span class="hljs-attr">$expr</span>: {
            <span class="hljs-attr">$gt</span> : [
                {<span class="hljs-attr">$size</span>: <span class="hljs-string">"$countries"</span>}, 
                <span class="hljs-number">1</span> 
            ]
        }
    }
)
</code></pre>
<p><strong>Note:</strong> I covered here some of the operators, and you can check the documentation for the full list of them.</p>
</div><h1 id="Aggregation-operations-in-MongoDB"><a class="anchor hidden-xs" href="#Aggregation-operations-in-MongoDB" title="Aggregation-operations-in-MongoDB"><i class="fa fa-link"></i></a>Aggregation operations in MongoDB</h1><p>Aggregation operations process data records and return computed results. Aggregation operations group values from multiple documents together, and can perform a variety of operations on the grouped data to return a single result.</p><p>MongoDB’s aggregation pipeline is a framework for data aggregation modeled on the concept of data processing pipelines. Documents enter a multi-stage pipeline that transforms the documents into an aggregated results. The pipeline consists of <strong>stages</strong>. Each stage transforms the documents as they pass through the pipeline. Pipeline stages do not need to produce one output document for every input document; e.g., some stages may generate new documents or filter out documents. MongoDB provides the <code>db.collection.aggregate()</code> method to run the aggregation pipeline.</p><p>For example, the following query returns the total amount for each customer only for orders whose status is A.</p><p><img src="https://i.imgur.com/EbPydJc.png" alt="" class="md-image md-image"></p><pre><code class="go hljs">db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{</span> $match<span class="token punctuation">:</span> <span class="token punctuation">{</span> status<span class="token punctuation">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token string">"$cust_id"</span><span class="token punctuation">,</span> total<span class="token punctuation">:</span> <span class="token punctuation">{</span> $sum<span class="token punctuation">:</span> <span class="token string">"$amount"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><p><strong>First Stage:</strong> The <code>$match</code> stage filters the documents by the status field and passes to the next stage those documents that have status equal to “A”.</p><p><strong>Second Stage:</strong> The <code>$group</code> stage groups the documents by the <code>cust_id</code> field to calculate the sum of the amount for each unique <code>cust_id</code>.</p><h2 id="Example-with-Inventory-data"><a class="anchor hidden-xs" href="#Example-with-Inventory-data" title="Example-with-Inventory-data"><i class="fa fa-link"></i></a>Example with Inventory data</h2><p>Given the following 20 documents of <code>zipcodes</code> collection:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>zipcodes<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01001"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"AGAWAM"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.622739</span><span class="token punctuation">,</span> <span class="token number">42.070206</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">15338</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01011"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"CHESTER"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.988761</span><span class="token punctuation">,</span> <span class="token number">42.279421</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">1688</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01012"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"CHESTERFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.833309</span><span class="token punctuation">,</span> <span class="token number">42.38167</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01013"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"CHICOPEE"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.607962</span><span class="token punctuation">,</span> <span class="token number">42.162046</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">23396</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01020"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"CHICOPEE"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.576142</span><span class="token punctuation">,</span> <span class="token number">42.176443</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">31495</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01022"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"WESTOVER AFB"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.558657</span><span class="token punctuation">,</span> <span class="token number">42.196672</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">1764</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01026"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"CUMMINGTON"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.905767</span><span class="token punctuation">,</span> <span class="token number">42.435296</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">1484</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01057"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"MONSON"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.31963399999999</span><span class="token punctuation">,</span> <span class="token number">42.101017</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">8194</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01060"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"FLORENCE"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.654245</span><span class="token punctuation">,</span> <span class="token number">42.324662</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">27939</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01103"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.588735</span><span class="token punctuation">,</span> <span class="token number">42.1029</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">2323</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01104"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.577769</span><span class="token punctuation">,</span> <span class="token number">42.128848</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">22115</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01105"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.578312</span><span class="token punctuation">,</span> <span class="token number">42.099931</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">14970</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01106"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"LONGMEADOW"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.5676</span><span class="token punctuation">,</span> <span class="token number">42.050658</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">15688</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01107"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.606544</span><span class="token punctuation">,</span> <span class="token number">42.117907</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">12739</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01108"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.558432</span><span class="token punctuation">,</span> <span class="token number">42.085314</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">25519</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01109"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.554349</span><span class="token punctuation">,</span> <span class="token number">42.114455</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">32635</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01118"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.527445</span><span class="token punctuation">,</span> <span class="token number">42.092937</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">14618</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01119"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.51211000000001</span><span class="token punctuation">,</span> <span class="token number">42.12473</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">13040</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01128"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.48890299999999</span><span class="token punctuation">,</span> <span class="token number">42.094397</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">3272</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"01129"</span><span class="token punctuation">,</span> <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"SPRINGFIELD"</span><span class="token punctuation">,</span> <span class="token string">"loc"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">72.487622</span><span class="token punctuation">,</span> <span class="token number">42.122263</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">6831</span><span class="token punctuation">,</span> <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"MA"</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>where each document has the following structure:</p><pre><code class="go hljs"><span class="token punctuation">{</span>
  <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token string">"10280"</span><span class="token punctuation">,</span>
  <span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"NEW YORK"</span><span class="token punctuation">,</span>
  <span class="token string">"state"</span><span class="token punctuation">:</span> <span class="token string">"NY"</span><span class="token punctuation">,</span>
  <span class="token string">"pop"</span><span class="token punctuation">:</span> <span class="token number">5574</span><span class="token punctuation">,</span>
  <span class="token string">"loc"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token operator">-</span><span class="token number">74.016323</span><span class="token punctuation">,</span>
    <span class="token number">40.710537</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>The <code>_id</code> field holds the zip code as a string.</li>
<li>The <code>city</code> field holds the city name. A city can have more than one zip code associated with it as different sections of the city can each have a different zip code.</li>
<li>The <code>state</code> field holds the two letter state abbreviation.</li>
<li>The <code>pop</code> field holds the population.</li>
<li>The <code>loc</code> field holds the location as a longitude latitude pair.</li>
</ul><p>Let’s run the following queries.</p><div class="alert alert-success">
<p><strong>Exercises on MonogDB</strong></p>
<ul>
<li>Return States with Populations above 10 Million</li>
</ul>
<details>
<pre><code class="go hljs">db<span class="token punctuation">.</span>zipcodes<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token string">"$state"</span><span class="token punctuation">,</span> totalPop<span class="token punctuation">:</span> <span class="token punctuation">{</span> $sum<span class="token punctuation">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> $match<span class="token punctuation">:</span> <span class="token punctuation">{</span> totalPop<span class="token punctuation">:</span> <span class="token punctuation">{</span> $gte<span class="token punctuation">:</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre>
<p>In this example, the aggregation pipeline consists of the <code>$group</code> stage followed by the <code>$match</code> stage:</p>
<ul>
<li>The <code>$group</code> stage groups the documents of the zipcode collection by the state field, calculates the totalPop field for each state, and outputs a document for each unique state. The new per-state documents have two fields: the <code>_id</code> field and the <code>totalPop</code> field. The _id field contains the value of the state; i.e. the group by field. The totalPop field is a calculated field that contains the total population of each state. To calculate the value, $group uses the $sum operator to add the population field (pop) for each state.</li>
</ul>
<p>After the $group stage, the documents in the pipeline resemble the following:</p>
<pre><code class="go hljs"><span class="token punctuation">{</span>
  <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"AK"</span><span class="token punctuation">,</span>
  <span class="token string">"totalPop"</span> <span class="token punctuation">:</span> <span class="token number">550043</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>The <code>$match</code> stage filters these grouped documents to output only those documents whose totalPop value is greater than or equal to 10 million. The <code>$match</code> stage does not alter the matching documents but outputs the matching documents unmodified.</li>
</ul>
<p>The equivalent SQL for this aggregation operation is:</p>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> state, <span class="hljs-keyword">SUM</span>(pop) <span class="hljs-keyword">AS</span> totalPop
<span class="hljs-keyword">FROM</span> zipcodes
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> state
<span class="hljs-keyword">HAVING</span> totalPop &gt;= (<span class="hljs-number">10</span>*<span class="hljs-number">1000</span>*<span class="hljs-number">1000</span>)
</code></pre>
</details>
</div><div class="alert alert-success">
<p><strong>Exercises on MonogDB</strong></p>
<ul>
<li>Return Average City Population by State</li>
</ul>
<details>
<pre><code class="go hljs">db<span class="token punctuation">.</span>zipcodes<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token punctuation">{</span> state<span class="token punctuation">:</span> <span class="token string">"$state"</span><span class="token punctuation">,</span> city<span class="token punctuation">:</span> <span class="token string">"$city"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> pop<span class="token punctuation">:</span> <span class="token punctuation">{</span> $sum<span class="token punctuation">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token string">"$_id.state"</span><span class="token punctuation">,</span> avgCityPop<span class="token punctuation">:</span> <span class="token punctuation">{</span> $avg<span class="token punctuation">:</span> <span class="token string">"$pop"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre>
<p>In this example, the aggregation pipeline consists of the <code>$group</code> stage followed by another <code>$group</code> stage:</p>
<ul>
<li>The first $group stage groups the documents by the combination of city and state, uses the $sum expression to calculate the population for each combination, and outputs a document for each city and state combination (A city can have more than one zip code associated with it as different sections of the city can each have a different zip code).</li>
</ul>
<p>After this stage in the pipeline, the documents resemble the following form:</p>
<pre><code class="go hljs"><span class="token punctuation">{</span>
  <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"state"</span> <span class="token punctuation">:</span> <span class="token string">"CO"</span><span class="token punctuation">,</span>
    <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"EDGEWATER"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"pop"</span> <span class="token punctuation">:</span> <span class="token number">13154</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>A second <code>$group</code> stage groups the documents in the pipeline by the <code>_id.state</code> field (i.e. the state field inside the _id document), uses the $avg expression to calculate the average city population (avgCityPop) for each state, and outputs a document for each state.</li>
</ul>
<p>The documents that result from this aggregation operation resembles the following:</p>
<pre><code class="go hljs"><span class="token punctuation">{</span>
  <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token string">"MN"</span><span class="token punctuation">,</span>
  <span class="token string">"avgCityPop"</span> <span class="token punctuation">:</span> <span class="token number">5335</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
</div><h3 id="Aggregation-pipelines"><a class="anchor hidden-xs" href="#Aggregation-pipelines" title="Aggregation-pipelines"><i class="fa fa-link"></i></a>Aggregation pipelines</h3><p>In the <code>db.collection.aggregate()</code> method, pipeline stages appear in an array. Documents pass through the stages in sequence. It has the following schema:</p><pre><code class="wrap javascript hljs">db.collection.aggregate( [ { &lt;stage&gt; }, ... ] )
</code></pre><div class="alert alert-warning">
<p>All stages except <code>$out</code> and <code>$merge</code>, can appear multiple times in the same pipeline.</p>
</div><p>The <code>$group</code> stage separates documents into groups according to a “group key”. The output is one document for each unique group key.</p><pre><code class="wrap javascript hljs">{
  <span class="hljs-attr">$group</span>:
    {
      <span class="hljs-attr">_id</span>: &lt;expression&gt;, // Group key
      &lt;field1&gt;: { &lt;accumulator1&gt; : &lt;expression1&gt; },
      ...
    }
 }
</code></pre><p>The <code>&lt;accumulator&gt;</code> operator must be one of the following accumulator operators:<br>
<img src="https://i.imgur.com/PqZ9wTI.png" alt="" class="md-image md-image"></p><p><code>&lt;expressions&gt;</code> can include field paths, literals, system variables, expression objects, and expression operators. Expressions can be nested. Field path is the path to a field in the document. To specify a field path, use a string that prefixes the field name with a dollar sign ($). For example, <code>"$user"</code> to specify the field path for the user field or <code>"$user.name"</code> to specify the field path to <code>"user.name"</code> field. <code>"$&lt;field&gt;"</code> is equivalent to <code>"$$CURRENT.&lt;field&gt;"</code> where the <code>CURRENT</code> is a system variable. Check <a href="https://www.mongodb.com/docs/v4.4/reference/aggregation-variables/#std-label-agg-system-variables" target="_blank" rel="noopener">here</a> for a list of system variables.</p><p>Check the <a href="https://www.mongodb.com/docs/v4.4/meta/aggregation-quick-reference" target="_blank" rel="noopener">documentation</a> for other stages and pipeline operators.</p><div class="alert alert-success">
<p><strong>Exercises on MonogDB</strong></p>
<ul>
<li>Retrieve the average number of comments for each movie type.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.aggregate(
    [
        {
            <span class="hljs-attr">$group</span>:{
                <span class="hljs-attr">_id</span>: <span class="hljs-string">"$type"</span>, 
                <span class="hljs-attr">average</span>: {<span class="hljs-attr">$avg</span>: <span class="hljs-string">"$num_mflix_comments"</span>
                         }
            }
        }
    ]
)
</code></pre>
<ul>
<li>Retrieve the average of comments for each movie type casted in China order by the average in ascending order.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.aggregate(
    [
        {
            <span class="hljs-attr">$match</span>:{
                <span class="hljs-attr">countries</span>:{
                    <span class="hljs-attr">$in</span>:[<span class="hljs-string">'China'</span>]
                }
            }
        },
        {
            <span class="hljs-attr">$group</span>:{
             <span class="hljs-attr">_id</span>: <span class="hljs-string">"$type"</span>, 
             <span class="hljs-attr">average</span>: {
                 <span class="hljs-attr">$avg</span>: <span class="hljs-string">"$num_mflix_comments"</span>
             }
            }
        },
        {
            <span class="hljs-attr">$sort</span>:{
                <span class="hljs-attr">average</span>: <span class="hljs-number">1</span>,
            }
        }
    ]
)
</code></pre>
<ul>
<li>Retrieve the average number of casts for each movie type.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.aggregate(
    [
        {
            <span class="hljs-attr">$match</span>:
            {
                <span class="hljs-attr">cast</span>:
                {
                    <span class="hljs-attr">$ne</span>:<span class="hljs-literal">null</span>
                }
            }
        }, 
        {
            <span class="hljs-attr">$addFields</span>: 
            {
                <span class="hljs-attr">cast_size</span>: 
                {
                    <span class="hljs-attr">$size</span> : <span class="hljs-string">"$cast"</span>
                }
            }
        }, 
        {
            <span class="hljs-attr">$group</span>:
            { 
                <span class="hljs-attr">_id</span>: <span class="hljs-string">"$type"</span>, 
                <span class="hljs-attr">cast_average</span>: 
                {
                    <span class="hljs-attr">$avg</span>: <span class="hljs-string">"$cast_size"</span>
                }
            }
        }, 
        {
            <span class="hljs-attr">$addFields</span>:
            {
                <span class="hljs-attr">cast_average_int</span>:
                {
                    <span class="hljs-attr">$toInt</span>:<span class="hljs-string">"$cast_average"</span>
                }
            }
        }
    ]
)
</code></pre>
<ul>
<li>Retrieve the number of movies and series for each country order by count in descending order. Return only top 5 results and store them in a new collection <code>country_movie_count</code>.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.aggregate(
    [
        {
            <span class="hljs-attr">$match</span>:
            {
                <span class="hljs-attr">type</span>:
                {
                    <span class="hljs-attr">$ne</span>:<span class="hljs-literal">null</span>
                }, 
                <span class="hljs-attr">countries</span>:
                {
                    <span class="hljs-attr">$type</span>:<span class="hljs-string">"array"</span>
                }
            }
        }, 
        {
            <span class="hljs-attr">$unwind</span>: <span class="hljs-string">"$countries"</span> 
        }, 
        {
            <span class="hljs-attr">$group</span>:
            { 
                <span class="hljs-attr">_id</span>: [
                    <span class="hljs-string">"$countries"</span>, 
                    <span class="hljs-string">"$type"</span>
                ], 
                <span class="hljs-attr">count</span>: 
                {
                    <span class="hljs-attr">$count</span>: {}
                }
            }
        }, 
        {
            <span class="hljs-attr">$sort</span>:
            {
                <span class="hljs-attr">count</span>:<span class="hljs-number">-1</span>
            }
        }, 
        {
            <span class="hljs-attr">$limit</span>:<span class="hljs-number">5</span>
        }, 
        {
            <span class="hljs-attr">$project</span>: 
            {
                <span class="hljs-attr">_id</span>:<span class="hljs-literal">false</span>, 
                <span class="hljs-string">'Country'</span>: 
                {
                    <span class="hljs-attr">$arrayElemAt</span>: [<span class="hljs-string">"$_id"</span>, <span class="hljs-number">0</span>]
                }, 
                <span class="hljs-string">'Movie'</span>:
                {
                    <span class="hljs-attr">$arrayElemAt</span>:[<span class="hljs-string">"$_id"</span>, <span class="hljs-number">1</span>]
                }, 
                <span class="hljs-attr">count</span>:<span class="hljs-literal">true</span> 
            }
        } , 
        {
            <span class="hljs-attr">$out</span>: <span class="hljs-string">"country_movie_count"</span>
        }
    ]
)
</code></pre>
</div><h2 id="Joins"><a class="anchor hidden-xs" href="#Joins" title="Joins"><i class="fa fa-link"></i></a>Joins</h2><p>We can join documents on collections in MongoDB by using the <code>$lookup</code> (Aggregation) function. <code>$lookup</code>(Aggregation) creates an outer left join with another collection and helps to filter data from merged data. If documents are part of a “joined” collection, the <code>$lookup</code> (Aggregation) function will return documents in the form of a subarray of the original collection.<br>
In MongoDB’s JOIN operation, the goal is to connect one set of data to another set of data. To join two collections, we use the <code>$lookup</code> operator, whose syntax is defined below:</p><pre><code class="go hljs"><span class="token punctuation">{</span>
   $lookup<span class="token punctuation">:</span>
     <span class="token punctuation">{</span>
       from<span class="token punctuation">:</span> <span class="token operator">&lt;</span>collection to join<span class="token operator">&gt;</span><span class="token punctuation">,</span>
       localField<span class="token punctuation">:</span> <span class="token operator">&lt;</span>field from the input documents<span class="token operator">&gt;</span><span class="token punctuation">,</span>
       foreignField<span class="token punctuation">:</span> <span class="token operator">&lt;</span>field from the documents of the <span class="token string">"from"</span> collection<span class="token operator">&gt;</span><span class="token punctuation">,</span>
       as<span class="token punctuation">:</span> <span class="token operator">&lt;</span>output array field<span class="token operator">&gt;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>The <code>$lookup</code> function accepts a document containing these fields:</p><ul>
<li><strong>From:</strong> It describes the collection within an identical database that should be used for executing the join, but with sharded collection restrictions.</li>
<li><strong>LocalField:</strong> This field represents the input field from the documents to the stage of $lookup, which performs an equivalence match between the local-field and the foreign-field from the collection ‘from.’ If an input document does not have a value for a local-field, then this operator will give the field a null value for matching purposes.</li>
<li><strong>foreignField:</strong> This field contains data from the documents in the ‘from’ collection with which an equivalence match can be made between the foreignField and the localField. When a document in the collection ‘from’ does not have a foreignField value, this operator will set the field to null for further matching purposes.</li>
<li><strong>As:</strong> It specifies the name of the array field that needs to be added to the input documents. More so, a new array field also includes matching documents from the collection ‘from.’ The prevailing field will be overwritten if the stated name already exists in the input document.</li>
</ul><p><strong>Example:</strong></p><pre><code class="go hljs">
db<span class="token punctuation">.</span>address<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
            <span class="token string">"blk_no"</span><span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
            <span class="token string">"street"</span> <span class="token punctuation">:</span> <span class="token string">"dewey street"</span><span class="token punctuation">,</span>
            <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"United States of America"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span>
            <span class="token string">"blk_no"</span><span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
            <span class="token string">"street"</span> <span class="token punctuation">:</span> <span class="token string">"gordon street"</span><span class="token punctuation">,</span>
            <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"New Zealand"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
        <span class="token string">"acknowledged"</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"insertedIds"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594cdb59313217373673c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594cdb59313217373673d"</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

db<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"contact_name"</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
            <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">,</span>
            <span class="token string">"sex"</span> <span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
            <span class="token string">"citizenship"</span> <span class="token punctuation">:</span> <span class="token string">"Filipino"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"contact_name"</span><span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span>
            <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
            <span class="token string">"sex"</span> <span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
            <span class="token string">"citizenship"</span> <span class="token punctuation">:</span> <span class="token string">"Filipino"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
        <span class="token string">"acknowledged"</span> <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"insertedIds"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594dbb59313217373673e"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594dbb59313217373673f"</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><p>The join operation is:</p><pre><code class="go hljs">
db<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> $lookup<span class="token punctuation">:</span>
        <span class="token punctuation">{</span>
           from<span class="token punctuation">:</span> <span class="token string">"address"</span><span class="token punctuation">,</span>
           localField<span class="token punctuation">:</span> <span class="token string">"contact_name"</span><span class="token punctuation">,</span>
           foreignField<span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
           as<span class="token punctuation">:</span> <span class="token string">"address"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><details><summary>Output</summary>
<p>The output is:</p>
<pre><code class="go hljs">
Output<span class="token punctuation">:</span>
<span class="token punctuation">{</span>
        <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594dbb59313217373673e"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"contact_name"</span> <span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span> <span class="token punctuation">:</span> <span class="token number">27</span><span class="token punctuation">,</span>
        <span class="token string">"sex"</span> <span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
        <span class="token string">"citizenship"</span> <span class="token punctuation">:</span> <span class="token string">"Filipino"</span><span class="token punctuation">,</span>
        <span class="token string">"address"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                        <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594cdb59313217373673c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">"name"</span> <span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span>
                        <span class="token string">"blk_no"</span> <span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
                        <span class="token string">"street"</span> <span class="token punctuation">:</span> <span class="token string">"dewey street"</span><span class="token punctuation">,</span>
                        <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"United States of America"</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
        <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594dbb59313217373673f"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"contact_name"</span> <span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span>
        <span class="token string">"age"</span> <span class="token punctuation">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
        <span class="token string">"sex"</span> <span class="token punctuation">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
        <span class="token string">"citizenship"</span> <span class="token punctuation">:</span> <span class="token string">"Filipino"</span><span class="token punctuation">,</span>
        <span class="token string">"address"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                        <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"613594cdb59313217373673d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">"name"</span> <span class="token punctuation">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span>
                        <span class="token string">"blk_no"</span> <span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
                        <span class="token string">"street"</span> <span class="token punctuation">:</span> <span class="token string">"gordon street"</span><span class="token punctuation">,</span>
                        <span class="token string">"city"</span> <span class="token punctuation">:</span> <span class="token string">"New Zealand"</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre>
</details><p>To learn more about aggregation framework. I recommend the online book <a href="https://www.practical-mongodb-aggregations.com" target="_blank" rel="noopener"><code>https://www.practical-mongodb-aggregations.com</code></a>.</p><div class="alert alert-success">
<h3 id="Exercises-on-MongoDB"><a class="anchor hidden-xs" href="#Exercises-on-MongoDB" title="Exercises-on-MongoDB"><i class="fa fa-link"></i></a>Exercises on MongoDB</h3>
<ul>
<li>Retrieve number of movies watched by each user sorted by movies count in descending order.</li>
</ul>
<pre><code class="wrap javascript hljs">db.movies.aggregate(
    [
        {
            <span class="hljs-attr">$lookup</span>: 
            {
                <span class="hljs-attr">from</span>: <span class="hljs-string">"comments"</span>, 
                <span class="hljs-attr">foreignField</span>: <span class="hljs-string">"movie_id"</span>, 
                <span class="hljs-attr">localField</span>: <span class="hljs-string">"_id"</span>, 
                <span class="hljs-attr">as</span> : <span class="hljs-string">"movie_comments"</span>
            }
        }, 
        {
            <span class="hljs-attr">$out</span>: <span class="hljs-string">"movie_comments"</span>  
        }
    ]
)

db.movie_comments.aggregate(
    [
        {
            <span class="hljs-attr">$group</span>:
            {
                <span class="hljs-attr">_id</span>:<span class="hljs-string">"$movie_comments.email"</span>, 
                <span class="hljs-attr">movie_count</span>:
                {
                    <span class="hljs-attr">$count</span>:{}
                }
            }
        }, 
        {
            <span class="hljs-attr">$match</span>:
            {
                <span class="hljs-attr">_id</span>:
                {
                    <span class="hljs-attr">$not</span>:{<span class="hljs-attr">$size</span>: <span class="hljs-number">0</span>}
                }
            }
        }, 
        {
            <span class="hljs-attr">$sort</span>:{
                <span class="hljs-attr">movie_count</span>:<span class="hljs-number">-1</span>
            }
        }
    ]
)
</code></pre>
</div><h2 id="Text-search"><a class="anchor hidden-xs" href="#Text-search" title="Text-search"><i class="fa fa-link"></i></a>Text search</h2><p>If your documents include text fields then you can speed up text search via using <a href="https://www.mongodb.com/docs/v4.2/reference/operator/query/text/" target="_blank" rel="noopener"><code>$text</code></a> operator but you need to create an index for that field. <code>$text</code> performs a text search on the content of the fields indexed with a text index. A <code>$text</code> expression has the following syntax:</p><pre><code class="go hljs"><span class="token punctuation">{</span>
  $text<span class="token punctuation">:</span>
    <span class="token punctuation">{</span>
      $search<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      $language<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      $caseSensitive<span class="token punctuation">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      $diacriticSensitive<span class="token punctuation">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Example:<br>
The following examples assume a collection articles that has a version 3 <code>text</code> index on the field subject:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> subject<span class="token punctuation">:</span> <span class="token string">"text"</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>Populate the collection with the following documents:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
   <span class="token punctuation">[</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"coffee"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"Coffee Shopping"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"Baking a cake"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">90</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"baking"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"Café Con Leche"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"Сырники"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"jkl"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">80</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"coffee and cream"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> subject<span class="token punctuation">:</span> <span class="token string">"Cafe con Leche"</span><span class="token punctuation">,</span> author<span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> views<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre><h3 id="Search-for-a-Single-Word"><a class="anchor hidden-xs" href="#Search-for-a-Single-Word" title="Search-for-a-Single-Word"><i class="fa fa-link"></i></a>Search for a Single Word</h3><p>The following query specifies a <code>$search</code> string of “coffee”:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> <span class="token string">"coffee"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>This query returns the documents that contain the term coffee in the indexed subject field, or more precisely, the stemmed version of the word:</p><pre><code class="go hljs"><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"Coffee Shopping"</span><span class="token punctuation">,</span> <span class="token string">"author"</span> <span class="token punctuation">:</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"views"</span> <span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"coffee and cream"</span><span class="token punctuation">,</span> <span class="token string">"author"</span> <span class="token punctuation">:</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"views"</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"coffee"</span><span class="token punctuation">,</span> <span class="token string">"author"</span> <span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string">"views"</span> <span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span>
</code></pre><h3 id="Exclude-Documents-That-Contain-a-Term"><a class="anchor hidden-xs" href="#Exclude-Documents-That-Contain-a-Term" title="Exclude-Documents-That-Contain-a-Term"><i class="fa fa-link"></i></a>Exclude Documents That Contain a Term</h3><p>The following example searches for documents that contain the words coffee but do not contain the term shop, or more precisely the stemmed version of the words:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> <span class="token string">"coffee -shop"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre><p>The query returns the following documents:</p><pre><code class="go hljs"><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"coffee and cream"</span><span class="token punctuation">,</span> <span class="token string">"author"</span> <span class="token punctuation">:</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"views"</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"coffee"</span><span class="token punctuation">,</span> <span class="token string">"author"</span> <span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string">"views"</span> <span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span>
</code></pre><h3 id="Return-the-Text-Search-Score"><a class="anchor hidden-xs" href="#Return-the-Text-Search-Score" title="Return-the-Text-Search-Score"><i class="fa fa-link"></i></a>Return the Text Search Score</h3><p>The following query searches for the term cake and returns the score assigned to each matching document:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span> $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> <span class="token string">"cake"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">"textScore"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><p>The returned document includes an additional field score that contains the document’s score associated with the text search. <a href="https://www.mongodb.com/docs/v4.2/reference/operator/aggregation/meta/#exp._S_meta" target="_blank" rel="noopener"><code>$meta</code></a> operator is an aggregation operator.</p><h3 id="Text-Search-with-Additional-Query-and-Sort-Expressions"><a class="anchor hidden-xs" href="#Text-Search-with-Additional-Query-and-Sort-Expressions" title="Text-Search-with-Additional-Query-and-Sort-Expressions"><i class="fa fa-link"></i></a>Text Search with Additional Query and Sort Expressions</h3><p>The following query searches for documents where the author equals “xyz” and the indexed field subject contains the terms coffee or bake. The operation also specifies a sort order of ascending date, then descending text search score:</p><pre><code class="go hljs">db<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> 
        author<span class="token punctuation">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> 
        $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> <span class="token string">"coffee bake"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> 
        score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">"textScore"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> 
    <span class="token punctuation">{</span> 
        date<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">"textScore"</span><span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">)</span>
</code></pre><h1 id="References"><a class="anchor hidden-xs" href="#References" title="References"><i class="fa fa-link"></i></a>References</h1><ul>
<li><a href="https://pymongo.readthedocs.io/en/3.13.0/" target="_blank" rel="noopener">PyMongo 3.13.0 documentation</a></li>
<li><a href="https://www.mongodb.com/docs/v4.2/introduction/" target="_blank" rel="noopener">MongoDB v4.2 docs</a></li>
<li><a href="https://hevodata.com/learn/mongodb-join-two-collections/#l2" target="_blank" rel="noopener">MongoDB Join example</a></li>
<li><a href="https://www.studytonight.com/mongodb/introduction-to-mongodb" target="_blank" rel="noopener">Intro to MongoDB</a></li>
</ul></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav">
<li class=""><a href="#Lab-4---Mongodb" title="Lab 4 - Mongodb">Lab 4 - Mongodb</a><ul class="nav">
<li><a href="#Dataset" title="Dataset">Dataset</a></li>
<li><a href="#Readings" title="Readings">Readings</a></li>
</ul>
</li>
<li><a href="#Agenda" title="Agenda">Agenda</a></li>
<li><a href="#Prerequisites" title="Prerequisites">Prerequisites</a></li>
<li><a href="#Objectives" title="Objectives">Objectives</a></li>
<li><a href="#Introduction" title="Introduction">Introduction</a></li>
<li><a href="#Install-MongoDB" title="Install MongoDB">Install MongoDB</a></li>
<li><a href="#Install-PyMongo-package" title="Install PyMongo package">Install PyMongo package</a></li>
<li><a href="#MongoDB-Databases-and-Collections" title="MongoDB Databases and Collections">MongoDB Databases and Collections</a><ul class="nav">
<li><a href="#Arrays-Dot-Notation-and-Embedded-documents" title="Arrays, Dot Notation and Embedded documents">Arrays, Dot Notation and Embedded documents</a></li>
</ul>
</li>
<li><a href="#Data-Description" title="Data Description">Data Description</a></li>
<li><a href="#Build-a-MongoDB-document-store" title="Build a MongoDB document store">Build a MongoDB document store</a></li>
<li><a href="#MongoDB-CRUD-Operations" title="MongoDB CRUD Operations">MongoDB CRUD Operations</a><ul class="nav">
<li><a href="#Create-database" title="Create database">Create database</a></li>
<li><a href="#Drop-database" title="Drop database">Drop database</a></li>
<li><a href="#Show-databases" title="Show databases">Show databases</a></li>
<li><a href="#Show-collections" title="Show collections">Show collections</a></li>
<li><a href="#Create-collections" title="Create collections">Create collections</a></li>
<li><a href="#Drop-collections" title="Drop collections">Drop collections</a></li>
<li><a href="#Insert-documents" title="Insert documents">Insert documents</a></li>
<li><a href="#Retrieve-documents" title="Retrieve documents">Retrieve documents</a><ul class="nav">
<li><a href="#Select-All-Documents-in-a-Collection" title="Select All Documents in a Collection">Select All Documents in a Collection</a></li>
<li><a href="#Specify-Equality-Condition" title="Specify Equality Condition">Specify Equality Condition</a></li>
<li><a href="#Specify-Conditions-Using-Query-Operators" title="Specify Conditions Using Query Operators">Specify Conditions Using Query Operators</a></li>
<li><a href="#Specify-AND-Conditions" title="Specify AND Conditions">Specify AND Conditions</a></li>
<li><a href="#Specify-OR-Conditions" title="Specify OR Conditions">Specify OR Conditions</a></li>
<li><a href="#Specify-AND-as-well-as-OR-Conditions" title="Specify AND as well as OR Conditions">Specify AND as well as OR Conditions</a></li>
<li><a href="#Query-on-EmbeddedNested-Documents" title="Query on Embedded/Nested Documents">Query on Embedded/Nested Documents</a></li>
<li><a href="#Query-on-Nested-Field" title="Query on Nested Field">Query on Nested Field</a></li>
</ul>
</li>
<li><a href="#Query-operators" title="Query operators">Query operators</a></li>
</ul>
</li>
<li class=""><a href="#Aggregation-operations-in-MongoDB" title="Aggregation operations in MongoDB">Aggregation operations in MongoDB</a><ul class="nav">
<li class=""><a href="#Example-with-Inventory-data" title="Example with Inventory data">Example with Inventory data</a><ul class="nav">
<li class=""><a href="#Aggregation-pipelines" title="Aggregation pipelines">Aggregation pipelines</a></li>
</ul>
</li>
<li class=""><a href="#Joins" title="Joins">Joins</a></li>
<li class=""><a href="#Text-search" title="Text search">Text search</a><ul class="nav">
<li class=""><a href="#Search-for-a-Single-Word" title="Search for a Single Word">Search for a Single Word</a></li>
<li class=""><a href="#Exclude-Documents-That-Contain-a-Term" title="Exclude Documents That Contain a Term">Exclude Documents That Contain a Term</a></li>
<li class=""><a href="#Return-the-Text-Search-Score" title="Return the Text Search Score">Return the Text Search Score</a></li>
<li><a href="#Text-Search-with-Additional-Query-and-Sort-Expressions" title="Text Search with Additional Query and Sort Expressions">Text Search with Additional Query and Sort Expressions</a></li>
</ul>
</li>
</ul>
</li>
<li class=""><a href="#References" title="References">References</a></li>
</ul>
</div><div class="toc-menu" style="">
    <a class="expand-toggle expand-all" href="#">Expand all</a>
    <a class="expand-toggle collapse-all" href="#" style="display: none;">Collapse all</a>
    <a class="back-to-top" href="#">Back to top</a>
    <a class="go-to-bottom" href="#">Go to bottom</a>
</div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc"><ul class="nav">
<li class=""><a href="#Lab-4---Mongodb" title="Lab 4 - Mongodb">Lab 4 - Mongodb</a><ul class="nav">
<li><a href="#Dataset" title="Dataset">Dataset</a></li>
<li><a href="#Readings" title="Readings">Readings</a></li>
</ul>
</li>
<li><a href="#Agenda" title="Agenda">Agenda</a></li>
<li><a href="#Prerequisites" title="Prerequisites">Prerequisites</a></li>
<li><a href="#Objectives" title="Objectives">Objectives</a></li>
<li><a href="#Introduction" title="Introduction">Introduction</a></li>
<li><a href="#Install-MongoDB" title="Install MongoDB">Install MongoDB</a></li>
<li><a href="#Install-PyMongo-package" title="Install PyMongo package">Install PyMongo package</a></li>
<li><a href="#MongoDB-Databases-and-Collections" title="MongoDB Databases and Collections">MongoDB Databases and Collections</a><ul class="nav">
<li><a href="#Arrays-Dot-Notation-and-Embedded-documents" title="Arrays, Dot Notation and Embedded documents">Arrays, Dot Notation and Embedded documents</a></li>
</ul>
</li>
<li><a href="#Data-Description" title="Data Description">Data Description</a></li>
<li><a href="#Build-a-MongoDB-document-store" title="Build a MongoDB document store">Build a MongoDB document store</a></li>
<li><a href="#MongoDB-CRUD-Operations" title="MongoDB CRUD Operations">MongoDB CRUD Operations</a><ul class="nav">
<li><a href="#Create-database" title="Create database">Create database</a></li>
<li><a href="#Drop-database" title="Drop database">Drop database</a></li>
<li><a href="#Show-databases" title="Show databases">Show databases</a></li>
<li><a href="#Show-collections" title="Show collections">Show collections</a></li>
<li><a href="#Create-collections" title="Create collections">Create collections</a></li>
<li><a href="#Drop-collections" title="Drop collections">Drop collections</a></li>
<li><a href="#Insert-documents" title="Insert documents">Insert documents</a></li>
<li><a href="#Retrieve-documents" title="Retrieve documents">Retrieve documents</a><ul class="nav">
<li><a href="#Select-All-Documents-in-a-Collection" title="Select All Documents in a Collection">Select All Documents in a Collection</a></li>
<li><a href="#Specify-Equality-Condition" title="Specify Equality Condition">Specify Equality Condition</a></li>
<li><a href="#Specify-Conditions-Using-Query-Operators" title="Specify Conditions Using Query Operators">Specify Conditions Using Query Operators</a></li>
<li><a href="#Specify-AND-Conditions" title="Specify AND Conditions">Specify AND Conditions</a></li>
<li><a href="#Specify-OR-Conditions" title="Specify OR Conditions">Specify OR Conditions</a></li>
<li><a href="#Specify-AND-as-well-as-OR-Conditions" title="Specify AND as well as OR Conditions">Specify AND as well as OR Conditions</a></li>
<li><a href="#Query-on-EmbeddedNested-Documents" title="Query on Embedded/Nested Documents">Query on Embedded/Nested Documents</a></li>
<li><a href="#Query-on-Nested-Field" title="Query on Nested Field">Query on Nested Field</a></li>
</ul>
</li>
<li><a href="#Query-operators" title="Query operators">Query operators</a></li>
</ul>
</li>
<li class=""><a href="#Aggregation-operations-in-MongoDB" title="Aggregation operations in MongoDB">Aggregation operations in MongoDB</a><ul class="nav">
<li class=""><a href="#Example-with-Inventory-data" title="Example with Inventory data">Example with Inventory data</a><ul class="nav">
<li class=""><a href="#Aggregation-pipelines" title="Aggregation pipelines">Aggregation pipelines</a></li>
</ul>
</li>
<li class=""><a href="#Joins" title="Joins">Joins</a></li>
<li class=""><a href="#Text-search" title="Text search">Text search</a><ul class="nav">
<li class=""><a href="#Search-for-a-Single-Word" title="Search for a Single Word">Search for a Single Word</a></li>
<li class=""><a href="#Exclude-Documents-That-Contain-a-Term" title="Exclude Documents That Contain a Term">Exclude Documents That Contain a Term</a></li>
<li class=""><a href="#Return-the-Text-Search-Score" title="Return the Text Search Score">Return the Text Search Score</a></li>
<li><a href="#Text-Search-with-Additional-Query-and-Sort-Expressions" title="Text Search with Additional Query and Sort Expressions">Text Search with Additional Query and Sort Expressions</a></li>
</ul>
</li>
</ul>
</li>
<li class=""><a href="#References" title="References">References</a></li>
</ul>
</div><div class="toc-menu" style="">
    <a class="expand-toggle expand-all" href="#">Expand all</a>
    <a class="expand-toggle collapse-all" href="#" style="display: none;">Collapse all</a>
    <a class="back-to-top" href="#">Back to top</a>
    <a class="go-to-bottom" href="#">Go to bottom</a>
</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.0/js/bootstrap.min.js" integrity="sha256-kJrlY+s09+QoWjpkOrXXwhxeaoDz9FW5SaxF8I0DibQ=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
